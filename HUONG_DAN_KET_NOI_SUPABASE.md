# H∆∞·ªõng D·∫´n K·∫øt N·ªëi Supabase C·ªßa B·∫°n

H∆∞·ªõng d·∫´n n√†y s·∫Ω gi√∫p b·∫°n k·∫øt n·ªëi ·ª©ng d·ª•ng v·ªõi Supabase project ri√™ng c·ªßa b·∫°n. L√†m theo t·ª´ng b∆∞·ªõc b√™n d∆∞·ªõi v√† b·∫°n s·∫Ω th√†nh c√¥ng!

---

## B∆∞·ªõc 1: T·∫°o Supabase Project

1. Truy c·∫≠p [https://supabase.com](https://supabase.com)
2. ƒêƒÉng nh·∫≠p ho·∫∑c ƒëƒÉng k√Ω t√†i kho·∫£n m·ªõi (mi·ªÖn ph√≠)
3. Click v√†o n√∫t **"New Project"**
4. ƒêi·ªÅn th√¥ng tin:
   - **Project Name**: ƒê·∫∑t t√™n project c·ªßa b·∫°n (v√≠ d·ª•: `bluebolt-management`)
   - **Database Password**: T·∫°o m·∫≠t kh·∫©u m·∫°nh (l∆∞u l·∫°i m·∫≠t kh·∫©u n√†y)
   - **Region**: Ch·ªçn region g·∫ßn b·∫°n nh·∫•t (v√≠ d·ª•: `Southeast Asia (Singapore)`)
   - **Pricing Plan**: Ch·ªçn **Free** ƒë·ªÉ b·∫Øt ƒë·∫ßu
5. Click **"Create new project"** v√† ƒë·ª£i 1-2 ph√∫t ƒë·ªÉ Supabase kh·ªüi t·∫°o

---

## B∆∞·ªõc 2: L·∫•y API Keys v√† URL

Sau khi project ƒë∆∞·ª£c t·∫°o xong:

1. V√†o menu b√™n tr√°i, click v√†o **Settings** (icon b√°nh rƒÉng ‚öôÔ∏è)
2. Click v√†o **API** trong menu Settings
3. B·∫°n s·∫Ω th·∫•y th√¥ng tin sau:

### Th√¥ng tin c·∫ßn l·∫•y:

- **Project URL**: C√≥ d·∫°ng `https://xxxxxxxxxxx.supabase.co`
- **Project Reference ID**: Ph·∫ßn `xxxxxxxxxxx` trong URL (v√≠ d·ª•: `lnkcxrkwfcgpjrjrkqqw`)
- **anon/public key**: Key d√†i b·∫Øt ƒë·∫ßu b·∫±ng `eyJhbGciOi...`

> **L∆∞u √Ω**: C√≥ 2 lo·∫°i key:
> - `anon public`: D√πng cho frontend (an to√†n ƒë·ªÉ public)
> - `service_role`: D√πng cho backend (KH√îNG BAO GI·ªú ƒë·ªÉ l·ªô key n√†y)
>
> Ch√∫ng ta ch·ªâ c·∫ßn **anon public key**

---

## B∆∞·ªõc 3: C·∫≠p Nh·∫≠t File `.env`

M·ªü file `.env` ·ªü th∆∞ m·ª•c g·ªëc c·ªßa project v√† c·∫≠p nh·∫≠t:

```env
VITE_SUPABASE_URL=https://xxxxxxxxxxx.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOi...
```

**Thay th·∫ø**:
- `https://xxxxxxxxxxx.supabase.co` b·∫±ng **Project URL** c·ªßa b·∫°n
- `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOi...` b·∫±ng **anon public key** c·ªßa b·∫°n

**V√≠ d·ª• c·ª• th·ªÉ**:
```env
VITE_SUPABASE_URL=https://lnkcxrkwfcgpjrjrkqqw.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxua2N4cmt3ZmNncGpyanJrcXF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNDE3NDIsImV4cCI6MjA4MzcxNzc0Mn0.PRwM50-QHNamzHGVxJ3ueAaCpz_GAaYl7pdsabqV1_M
```

---

## B∆∞·ªõc 4: C·∫≠p Nh·∫≠t File `src/utils/supabase/info.tsx`

M·ªü file `src/utils/supabase/info.tsx` v√† thay ƒë·ªïi:

```typescript
/* AUTOGENERATED FILE - DO NOT EDIT CONTENTS */

export const projectId = "xxxxxxxxxxx"  // Thay b·∫±ng Project Reference ID c·ªßa b·∫°n
export const publicAnonKey = "eyJhbGciOi..."  // Thay b·∫±ng anon public key c·ªßa b·∫°n
```

**V√≠ d·ª• c·ª• th·ªÉ**:
```typescript
/* AUTOGENERATED FILE - DO NOT EDIT CONTENTS */

export const projectId = "lnkcxrkwfcgpjrjrkqqw"
export const publicAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxua2N4cmt3ZmNncGpyanJrcXF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNDE3NDIsImV4cCI6MjA4MzcxNzc0Mn0.PRwM50-QHNamzHGVxJ3ueAaCpz_GAaYl7pdsabqV1_M"
```

---

## B∆∞·ªõc 5: T·∫°o Database Schema (T√πy ch·ªçn)

N·∫øu b·∫°n mu·ªën s·ª≠ d·ª•ng **Postgres Database** thay v√¨ KV Store:

1. M·ªü Supabase Dashboard c·ªßa b·∫°n
2. V√†o **SQL Editor** (icon </> ·ªü sidebar b√™n tr√°i)
3. Click **New Query**
4. M·ªü file `supabase_schema.sql` trong project
5. Copy to√†n b·ªô n·ªôi dung
6. Paste v√†o SQL Editor
7. Click **Run** (ho·∫∑c nh·∫•n Ctrl+Enter / Cmd+Enter)
8. ƒê·ª£i v√†i gi√¢y ƒë·ªÉ migration ho√†n t·∫•t

File SQL n√†y s·∫Ω t·∫°o:
- 6 b·∫£ng ch√≠nh: `business_units`, `employees`, `partners`, `transactions`, `users`, `master_data`
- Row Level Security (RLS) policies
- Indexes ƒë·ªÉ t·ªëi ∆∞u performance
- Triggers t·ª± ƒë·ªông c·∫≠p nh·∫≠t `updated_at`
- D·ªØ li·ªáu m·∫´u ƒë·ªÉ test
- Views cho analytics

> **L∆∞u √Ω**: B∆∞·ªõc n√†y l√† **t√πy ch·ªçn**. Hi·ªán t·∫°i ·ª©ng d·ª•ng ƒëang d√πng **KV Store** (key-value storage) n√™n kh√¥ng c·∫ßn t·∫°o tables. Nh∆∞ng n·∫øu sau n√†y b·∫°n mu·ªën migrate sang Postgres, h√£y ch·∫°y file SQL n√†y.

---

## B∆∞·ªõc 6: Deploy Edge Function

·ª®ng d·ª•ng n√†y s·ª≠ d·ª•ng **Supabase Edge Functions** ƒë·ªÉ x·ª≠ l√Ω API. B·∫°n c·∫ßn deploy function l√™n Supabase c·ªßa b·∫°n.

> **L∆∞u √Ω**: Edge Function code n·∫±m trong th∆∞ m·ª•c `supabase/functions/make-server-393f5b29/`

### 6.1. C√†i ƒë·∫∑t Supabase CLI

**Tr√™n macOS**:
```bash
brew install supabase/tap/supabase
```

**Tr√™n Windows**:
```powershell
scoop bucket add supabase https://github.com/supabase/scoop-bucket.git
scoop install supabase
```

**Tr√™n Linux**:
```bash
brew install supabase/tap/supabase
```

### 6.2. Login v√†o Supabase

```bash
supabase login
```

M·ªôt tr√¨nh duy·ªát s·∫Ω m·ªü ra ƒë·ªÉ b·∫°n ƒëƒÉng nh·∫≠p. Sau khi ƒëƒÉng nh·∫≠p th√†nh c√¥ng, quay l·∫°i terminal.

### 6.3. Link Project

```bash
supabase link --project-ref xxxxxxxxxxx
```

**Thay th·∫ø** `xxxxxxxxxxx` b·∫±ng **Project Reference ID** c·ªßa b·∫°n (v√≠ d·ª•: `lnkcxrkwfcgpjrjrkqqw`)

Khi ƒë∆∞·ª£c h·ªèi database password, nh·∫≠p password b·∫°n ƒë√£ t·∫°o ·ªü B∆∞·ªõc 1.

### 6.4. Deploy Edge Function

```bash
supabase functions deploy make-server-393f5b29 --no-verify-jwt
```

ƒê·ª£i v√†i gi√¢y ƒë·ªÉ function ƒë∆∞·ª£c deploy. B·∫°n s·∫Ω th·∫•y th√¥ng b√°o th√†nh c√¥ng:

```
Deploying function make-server-393f5b29...
Function deployed successfully!
URL: https://xxxxxxxxxxx.supabase.co/functions/v1/make-server-393f5b29
```

> **L∆∞u √Ω v·ªÅ `--no-verify-jwt`**: Flag n√†y cho ph√©p function ho·∫°t ƒë·ªông m√† kh√¥ng c·∫ßn x√°c th·ª±c JWT. N·∫øu b·∫°n mu·ªën b·∫£o m·∫≠t h∆°n, h√£y b·ªè flag n√†y v√† c·∫≠p nh·∫≠t code frontend ƒë·ªÉ g·ª≠i JWT token trong header.

---

## B∆∞·ªõc 7: Test K·∫øt N·ªëi

### 7.1. Test Edge Function

M·ªü tr√¨nh duy·ªát ho·∫∑c d√πng curl ƒë·ªÉ test:

```bash
curl https://xxxxxxxxxxx.supabase.co/functions/v1/make-server-393f5b29/health
```

**Thay th·∫ø** `xxxxxxxxxxx` b·∫±ng Project Reference ID c·ªßa b·∫°n.

N·∫øu th√†nh c√¥ng, b·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c:
```json
{"status":"ok"}
```

### 7.2. Kh·ªüi ƒë·ªông ·ª©ng d·ª•ng

```bash
npm install
npm run dev
```

·ª®ng d·ª•ng s·∫Ω ch·∫°y t·∫°i `http://localhost:5173`

### 7.3. Test ch·ª©c nƒÉng

1. ƒêƒÉng nh·∫≠p v·ªõi m·ªôt trong c√°c t√†i kho·∫£n demo:
   - **Email**: `ceo@bluebolt.vn`
   - **Password**: `ceo123`

2. Th·ª≠ t·∫°o m·ªôt Business Unit m·ªõi ho·∫∑c Transaction ƒë·ªÉ ki·ªÉm tra k·∫øt n·ªëi

---

## B∆∞·ªõc 8: Seed D·ªØ Li·ªáu M·∫´u (T√πy ch·ªçn)

ƒê·ªÉ c√≥ d·ªØ li·ªáu m·∫´u ban ƒë·∫ßu, b·∫°n c√≥ th·ªÉ g·ªçi endpoint seed:

```bash
curl -X POST https://xxxxxxxxxxx.supabase.co/functions/v1/make-server-393f5b29/seed \
  -H "Authorization: Bearer YOUR_ANON_KEY"
```

**Thay th·∫ø**:
- `xxxxxxxxxxx` b·∫±ng Project Reference ID c·ªßa b·∫°n
- `YOUR_ANON_KEY` b·∫±ng anon public key c·ªßa b·∫°n

Ho·∫∑c ƒë∆°n gi·∫£n h∆°n, d√πng browser ƒë·ªÉ truy c·∫≠p:
```
https://xxxxxxxxxxx.supabase.co/functions/v1/make-server-393f5b29/seed
```

---

## X·ª≠ L√Ω L·ªói Th∆∞·ªùng G·∫∑p

### L·ªói: "Failed to fetch" ho·∫∑c "Network error"

**Nguy√™n nh√¢n**: Edge Function ch∆∞a ƒë∆∞·ª£c deploy ho·∫∑c URL kh√¥ng ƒë√∫ng

**Gi·∫£i ph√°p**:
1. Ki·ªÉm tra l·∫°i Project Reference ID trong `src/utils/supabase/info.tsx`
2. Ch·∫Øc ch·∫Øn Edge Function ƒë√£ ƒë∆∞·ª£c deploy th√†nh c√¥ng
3. Test endpoint `/health` b·∫±ng curl ho·∫∑c browser

### L·ªói: "Invalid API key"

**Nguy√™n nh√¢n**: Anon key kh√¥ng ƒë√∫ng

**Gi·∫£i ph√°p**:
1. V√†o Supabase Dashboard > Settings > API
2. Copy l·∫°i **anon public key**
3. C·∫≠p nh·∫≠t v√†o file `.env` v√† `src/utils/supabase/info.tsx`
4. Restart ·ª©ng d·ª•ng (`npm run dev`)

### L·ªói: "Function not found"

**Nguy√™n nh√¢n**: Edge Function ch∆∞a ƒë∆∞·ª£c deploy ho·∫∑c t√™n function kh√¥ng ƒë√∫ng

**Gi·∫£i ph√°p**:
1. Ch·∫Øc ch·∫Øn b·∫°n ƒë√£ ch·∫°y: `supabase functions deploy make-server-393f5b29`
2. Ki·ªÉm tra trong Supabase Dashboard > Edge Functions xem function ƒë√£ c√≥ ch∆∞a

### L·ªói: "CORS error"

**Nguy√™n nh√¢n**: Edge Function kh√¥ng cho ph√©p CORS t·ª´ domain c·ªßa b·∫°n

**Gi·∫£i ph√°p**:
- Edge Function ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh CORS v·ªõi `origin: "*"`, n√™n l·ªói n√†y hi·∫øm khi x·∫£y ra
- N·∫øu v·∫´n g·∫∑p, ki·ªÉm tra l·∫°i file `src/supabase/functions/server/index.tsx`

---

## L∆∞u √ù Quan Tr·ªçng

1. **KH√îNG BAO GI·ªú** commit file `.env` l√™n Git
2. **KH√îNG BAO GI·ªú** share `service_role` key v·ªõi ai
3. File `.gitignore` ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh ƒë·ªÉ b·ªè qua `.env`
4. Edge Function s·ª≠ d·ª•ng **Supabase KV Store** (key-value storage), kh√¥ng ph·∫£i Postgres
5. D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u trong KV Store s·∫Ω persist (kh√¥ng m·∫•t khi restart)

---

## N√¢ng Cao: C·∫•u H√¨nh RLS (Row Level Security)

Hi·ªán t·∫°i ·ª©ng d·ª•ng s·ª≠ d·ª•ng KV Store n√™n kh√¥ng c√≥ RLS. N·∫øu sau n√†y b·∫°n mu·ªën chuy·ªÉn sang Postgres:

1. T·∫°o c√°c b·∫£ng trong Supabase Dashboard > SQL Editor
2. Enable RLS cho m·ªói b·∫£ng
3. T·∫°o policies ph√π h·ª£p
4. C·∫≠p nh·∫≠t code trong `src/supabase/functions/server/api.tsx` ƒë·ªÉ s·ª≠ d·ª•ng Postgres thay v√¨ KV Store

---

## H·ªó Tr·ª£

N·∫øu g·∫∑p v·∫•n ƒë·ªÅ, b·∫°n c√≥ th·ªÉ:
1. Ki·ªÉm tra l·∫°i t·ª´ng b∆∞·ªõc trong h∆∞·ªõng d·∫´n n√†y
2. Xem logs c·ªßa Edge Function trong Supabase Dashboard > Edge Functions > Logs
3. M·ªü Developer Tools trong browser (F12) v√† ki·ªÉm tra tab Network/Console

---

## Checklist T·ªïng H·ª£p

- [ ] ƒê√£ t·∫°o Supabase project m·ªõi
- [ ] ƒê√£ l·∫•y Project URL v√† anon key
- [ ] ƒê√£ c·∫≠p nh·∫≠t file `.env`
- [ ] ƒê√£ c·∫≠p nh·∫≠t file `src/utils/supabase/info.tsx`
- [ ] ƒê√£ c√†i ƒë·∫∑t Supabase CLI
- [ ] ƒê√£ login v√† link project
- [ ] ƒê√£ deploy Edge Function th√†nh c√¥ng
- [ ] ƒê√£ test endpoint `/health` th√†nh c√¥ng
- [ ] ƒê√£ ch·∫°y `npm install` v√† `npm run dev`
- [ ] ƒê√£ test ƒëƒÉng nh·∫≠p v√† c√°c ch·ª©c nƒÉng c∆° b·∫£n

---

**Ch√∫c b·∫°n th√†nh c√¥ng! üéâ**
