<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test K·∫øt N·ªëi Supabase</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .test-section {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .test-section.loading {
            border-color: #ffa500;
            background: #fff9e6;
        }

        .test-section.success {
            border-color: #4caf50;
            background: #e8f5e9;
        }

        .test-section.error {
            border-color: #f44336;
            background: #ffebee;
        }

        .test-title {
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }

        .status-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .status-icon.pending {
            background: #e0e0e0;
            color: #666;
        }

        .status-icon.loading {
            background: #ffa500;
            color: white;
            animation: spin 1s linear infinite;
        }

        .status-icon.success {
            background: #4caf50;
            color: white;
        }

        .status-icon.error {
            background: #f44336;
            color: white;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .test-result {
            font-size: 14px;
            color: #555;
            margin-top: 10px;
            line-height: 1.6;
        }

        .test-result pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin-top: 10px;
            font-size: 12px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 20px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .summary {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            background: #f5f5f5;
            font-weight: 600;
            text-align: center;
            font-size: 18px;
        }

        .summary.success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .summary.error {
            background: #ffebee;
            color: #c62828;
        }

        .config-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #666;
        }

        .config-info strong {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test K·∫øt N·ªëi Supabase</h1>
        <p class="subtitle">Ki·ªÉm tra k·∫øt n·ªëi ƒë·∫øn Supabase v√† Edge Functions</p>

        <div class="config-info" id="configInfo">
            <strong>ƒêang ƒë·ªçc c·∫•u h√¨nh...</strong>
        </div>

        <div class="test-section" id="test1">
            <div class="test-title">
                <span class="status-icon pending">‚è±</span>
                <span>1. Ki·ªÉm tra c·∫•u h√¨nh .env</span>
            </div>
            <div class="test-result" id="result1"></div>
        </div>

        <div class="test-section" id="test2">
            <div class="test-title">
                <span class="status-icon pending">‚è±</span>
                <span>2. Test Edge Function - Health Check</span>
            </div>
            <div class="test-result" id="result2"></div>
        </div>

        <div class="test-section" id="test3">
            <div class="test-title">
                <span class="status-icon pending">‚è±</span>
                <span>3. Test Database - ƒê·ªçc Business Units</span>
            </div>
            <div class="test-result" id="result3"></div>
        </div>

        <div class="test-section" id="test4">
            <div class="test-title">
                <span class="status-icon pending">‚è±</span>
                <span>4. Test Database - ƒê·ªçc Transactions</span>
            </div>
            <div class="test-result" id="result4"></div>
        </div>

        <button id="runTests">Ch·∫°y Test K·∫øt N·ªëi</button>

        <div class="summary" id="summary" style="display: none;"></div>
    </div>

    <script type="module">
        const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
        const SUPABASE_ANON_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY;

        let projectId = '';

        function updateConfigInfo() {
            const configDiv = document.getElementById('configInfo');

            if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                configDiv.innerHTML = `
                    <strong>‚ùå L·ªói C·∫•u H√¨nh!</strong><br>
                    Kh√¥ng t√¨m th·∫•y VITE_SUPABASE_URL ho·∫∑c VITE_SUPABASE_ANON_KEY trong file .env<br>
                    <small>H√£y ki·ªÉm tra l·∫°i file .env c·ªßa b·∫°n</small>
                `;
                return false;
            }

            try {
                const url = new URL(SUPABASE_URL);
                projectId = url.hostname.split('.')[0];

                configDiv.innerHTML = `
                    <strong>‚úÖ C·∫•u h√¨nh OK!</strong><br>
                    Project ID: <code>${projectId}</code><br>
                    URL: <code>${SUPABASE_URL}</code><br>
                    Key: <code>${SUPABASE_ANON_KEY.substring(0, 20)}...</code>
                `;
                return true;
            } catch (e) {
                configDiv.innerHTML = `
                    <strong>‚ùå URL kh√¥ng h·ª£p l·ªá!</strong><br>
                    ${SUPABASE_URL}<br>
                    <small>URL ph·∫£i c√≥ d·∫°ng: https://xxxxxxxxxxx.supabase.co</small>
                `;
                return false;
            }
        }

        function updateTestStatus(testNum, status, message, data = null) {
            const section = document.getElementById(`test${testNum}`);
            const icon = section.querySelector('.status-icon');
            const result = document.getElementById(`result${testNum}`);

            section.className = `test-section ${status}`;
            icon.className = `status-icon ${status}`;

            if (status === 'loading') {
                icon.textContent = '‚è≥';
                result.textContent = 'ƒêang ki·ªÉm tra...';
            } else if (status === 'success') {
                icon.textContent = '‚úì';
                result.innerHTML = `<strong style="color: #2e7d32;">‚úÖ ${message}</strong>`;
                if (data) {
                    result.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            } else if (status === 'error') {
                icon.textContent = '‚úó';
                result.innerHTML = `<strong style="color: #c62828;">‚ùå ${message}</strong>`;
                if (data) {
                    result.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            }
        }

        async function test1_CheckEnv() {
            updateTestStatus(1, 'loading');

            await new Promise(resolve => setTimeout(resolve, 500));

            if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                updateTestStatus(1, 'error', 'Thi·∫øu bi·∫øn m√¥i tr∆∞·ªùng trong .env');
                return false;
            }

            if (!SUPABASE_URL.includes('supabase.co')) {
                updateTestStatus(1, 'error', 'URL kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng Supabase');
                return false;
            }

            updateTestStatus(1, 'success', 'C·∫•u h√¨nh .env h·ª£p l·ªá');
            return true;
        }

        async function test2_HealthCheck() {
            updateTestStatus(2, 'loading');

            const url = `${SUPABASE_URL}/functions/v1/make-server-393f5b29/health`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.status === 'ok') {
                    updateTestStatus(2, 'success', 'Edge Function ho·∫°t ƒë·ªông t·ªët!', data);
                    return true;
                } else {
                    updateTestStatus(2, 'error', `Response kh√¥ng nh∆∞ mong ƒë·ª£i (${response.status})`, data);
                    return false;
                }
            } catch (error) {
                updateTestStatus(2, 'error', `Kh√¥ng th·ªÉ k·∫øt n·ªëi: ${error.message}`, { error: error.toString() });
                return false;
            }
        }

        async function test3_ReadBusinessUnits() {
            updateTestStatus(3, 'loading');

            const url = `${SUPABASE_URL}/functions/v1/make-server-393f5b29/business-units`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    const count = data.data ? data.data.length : 0;
                    updateTestStatus(3, 'success', `ƒê·ªçc ƒë∆∞·ª£c ${count} Business Units`, {
                        count,
                        sample: data.data && data.data[0] ? data.data[0] : null
                    });
                    return true;
                } else {
                    updateTestStatus(3, 'error', 'Kh√¥ng th·ªÉ ƒë·ªçc d·ªØ li·ªáu', data);
                    return false;
                }
            } catch (error) {
                updateTestStatus(3, 'error', `L·ªói: ${error.message}`, { error: error.toString() });
                return false;
            }
        }

        async function test4_ReadTransactions() {
            updateTestStatus(4, 'loading');

            const url = `${SUPABASE_URL}/functions/v1/make-server-393f5b29/transactions`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    const count = data.data ? data.data.length : 0;
                    updateTestStatus(4, 'success', `ƒê·ªçc ƒë∆∞·ª£c ${count} Transactions`, {
                        count,
                        sample: data.data && data.data[0] ? data.data[0] : null
                    });
                    return true;
                } else {
                    updateTestStatus(4, 'error', 'Kh√¥ng th·ªÉ ƒë·ªçc d·ªØ li·ªáu', data);
                    return false;
                }
            } catch (error) {
                updateTestStatus(4, 'error', `L·ªói: ${error.message}`, { error: error.toString() });
                return false;
            }
        }

        async function runAllTests() {
            const button = document.getElementById('runTests');
            const summary = document.getElementById('summary');

            button.disabled = true;
            button.textContent = 'ƒêang ch·∫°y tests...';
            summary.style.display = 'none';

            const results = [];

            results.push(await test1_CheckEnv());
            if (!results[0]) {
                showSummary(results);
                button.disabled = false;
                button.textContent = 'Ch·∫°y L·∫°i Test';
                return;
            }

            results.push(await test2_HealthCheck());
            results.push(await test3_ReadBusinessUnits());
            results.push(await test4_ReadTransactions());

            showSummary(results);
            button.disabled = false;
            button.textContent = 'Ch·∫°y L·∫°i Test';
        }

        function showSummary(results) {
            const summary = document.getElementById('summary');
            const passed = results.filter(r => r).length;
            const total = results.length;

            summary.style.display = 'block';

            if (passed === total) {
                summary.className = 'summary success';
                summary.innerHTML = `
                    üéâ Ho√†n H·∫£o! T·∫•t c·∫£ ${total} tests ƒë·ªÅu PASS!<br>
                    <small style="font-weight: normal; margin-top: 10px; display: block;">
                        ‚úÖ K·∫øt n·ªëi Supabase th√†nh c√¥ng<br>
                        ‚úÖ Edge Function ho·∫°t ƒë·ªông t·ªët<br>
                        ‚úÖ Database ƒë·ªçc/ghi b√¨nh th∆∞·ªùng<br><br>
                        B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu s·ª≠ d·ª•ng ·ª©ng d·ª•ng!
                    </small>
                `;
            } else {
                summary.className = 'summary error';
                summary.innerHTML = `
                    ‚ö†Ô∏è ${passed}/${total} tests PASS<br>
                    <small style="font-weight: normal; margin-top: 10px; display: block;">
                        Vui l√≤ng ki·ªÉm tra c√°c test l·ªói ·ªü tr√™n v√† xem h∆∞·ªõng d·∫´n trong HUONG_DAN_KET_NOI_SUPABASE.md
                    </small>
                `;
            }
        }

        // Initialize
        const configOk = updateConfigInfo();

        document.getElementById('runTests').addEventListener('click', runAllTests);

        // Auto run if config is OK
        if (configOk) {
            setTimeout(runAllTests, 1000);
        }
    </script>
</body>
</html>
